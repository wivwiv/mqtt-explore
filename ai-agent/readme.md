# 消费电子 AI 助手

探索如何将 EMQX 与 Azure AI 结合，实现消费电子产品 AI 助手。

- EMQX：连接物理世界的桥梁，将消费电子产品的人类交互指令、传感器、执行器等连接到云端
- Azure AI：提供 AI 世界强大的处理能力，包括自然语言理解、多模态融合、上下文理解等

## 技术选型

- 边缘层：EMQX 消息中间件
- 处理层：Azure AI
- Agent 层：Node.js
- 设备层：MQTTX CLI 模拟设备发送消息，有关具体 DEMO 的指令和场景，请参考[操作示例](#操作示例)章节。

## 使用

1. 安装 Node.js
2. 安装相关依赖：`npm install` or `yarn`
3. 安装 MQTTX CLI
4. 修改源码中的配置参数
5. 运行：`node index.js`

## 基本流程与原理

消费电子产品通过两种方式与系统交互：

1. 直接上报：传感器指标、设备状态等结构化数据
2. 多模态交互：用户的语音指令、手势图像、视频等非结构化数据

数据流转过程：

1. 消费电子产品通过 BLE 将数据传输至边缘 AI 网关，或者通过 MQTT 直连 EMQX
2. 边缘层进行初步处理和数据清洗，通过 MQTT 转发至 EMQX 消息中间件
3. Agent 服务接收 MQTT 消息，将需要 AI 处理的请求通过 HTTP 转发给 Azure AI
4. Azure AI 处理后返回标准化指令，最终通过 EMQX MQTT 下发到具体设备

架构图：

```bash
设备层        边缘层          消息层        处理层         AI层
+--------+   +---------+   +-------+   +---------+   +---------+
|智能设备|<->|边缘AI   |   |       |   |         |   |         |
|传感器  |   |网关     |<->| EMQX  |<->| Agent   |<->| Azure   |
|执行器  |   |协议转换 |   |       |   | Service |   | AI      |
+--------+   +---------+   +-------+   +---------+   +---------+
   ^             ^            ^            ^            ^
   |             |            |            |            |
BLE/MQTT      MQTT          MQTT         HTTP        REST API

```

技术演进对比：

- 传统方案：如小爱同学、天猫精灵等，基于规则引擎和意图识别技术，需要大量人工标注训练数据和编写意图匹配规则
- AI 大模型方案：
  1. 支持自然语言理解，无需严格的指令格式
  2. 多模态融合能力，可同时处理语音、图像等多种输入
  3. 具备上下文理解，提供更智能的交互体验
  4. 持续学习优化，适应性更强

## 多模态数据预处理

### 目标

将多模态交互数据在边缘侧（MCU 或网关）转换为标准化事件指令，实现人类自然交互到设备控制的智能桥接。

### 实现方案

1. MCU 端轻量级 AI 推理
   - 通过在设备 MCU 上运行优化后的 AI 神经网络，实现基础的 AI 推理能力：
     - 语音识别（将语音转换为文本指令）
     - 视频动作检测（识别简单手势动作）
   - 输出标准化的事件指令（如：将挥手手势映射为"降下晾衣架"指令）

2. 边缘网关 AI 处理
   - 部署如 Phi-3.5 这样的小语言模型
   - 处理更复杂的场景：
     - 复杂的图像和视频理解
     - 多模态信息的综合分析
   - 双模工作机制：
     - 在线：将理解结果通过 MQTT 发送给 EMQX，通过云端模型推理规则
     - 离线：本地推理设备操作指令，保证系统可用性

## Azure AI 设备交互规则推理

### 什么是交互规则？

交互规则不仅仅是简单的指令映射，而是一个深度理解用户需求的过程。

以"打开空调"为例，这句简单的指令其实包含了丰富的信息量 —— 用户真正想要的是让室内环境变得舒适。因此：

- 需要开机，不能简单地执行"开机"操作
- 需要结合当前环境数据，比如温度、湿度、风速等
- 需要考虑用户的使用习惯，比如用户通常喜欢 3 档风速
- 需要选择设置合适的工作模式，比如制冷、制热、除湿等

如果不加以理解，造成的后果可能是不够智能：室内温度偏高，而空调开机后默认处于制热模式，不做其他调整显然不是用户想要的结果。

### 智能场景联动

#### 洗衣机和晾衣架的联动

想象一个更有趣的场景：洗衣机完成工作后自动降下晾衣架，用户可以直接晾衣。

传统方式：

- 用户经历了 999 次关联操作后，有一天思考，能不能自动帮我降下晾衣架？
- 摸索了软件之后，通过手动配置实现了联动："洗衣机开门时，自动降下晾衣架"

AI 自动识别真实存在的场景联动需求：

- AI 就像一个会观察和学习的孩子：当他们多次观察到父母在打开洗衣机后都会放下晾衣架，热心的他们会主动问父母，下次需要我帮忙吗？
- 对于 AI 来说，看到这一现象后，它能联想到这是一个真实存在的场景联动，因此 App 可以在合适的时机询问用户，是否要将其配置为自动执行？

#### 冰箱和机器人的故事

你可能会想在更先进的未来，如果家庭中有一个家务机器人，你让它帮忙去冰箱里拿一瓶饮料，它可能会说："好的，我需要先去冰箱里看看有什么饮料，然后帮你拿一瓶。"

哦不，它为什么还要先去看呢？别忘了机器之间是互通的，这样一来它就有了“透视眼” —— 冰箱可以直接告诉它有没有想要的饮料，它再决定是否需要去跑一趟。

如果你想吃鸡蛋，但冰箱里的鸡蛋是生的，而它恰巧不是一个会做饭的机器人，它可能也会直接告诉你，"嗨兄弟，你可能没法吃鸡蛋了，它是生的，看起来我俩都不会做。"

#### 还是冰箱和机器人的故事

某天冰箱发现自己的温度有点高，它报告给了制造商，制造商告诉它，"哦，我需要去看看冰箱的其他传感器是否正常。"

制造商让冰箱上报了所有传感器数据，看起来没有故障。会不会是冰箱被挡住了？这可没法去看。冰箱可以让机器人帮忙去看一下，看起来它比人类更擅长理解冰箱 —— 虽然冰箱内部是冷的，但冰箱外部的冷凝器是热的。如果冷凝器被挡住了，冰箱就没法工作，温度就会升高。

制造商让机器人帮忙看一下，如果它看不懂，拍个照发给制造商也行啊，PS：别忘记拍照得请求用户授权。

## 规则推理实现

这个 DEMO 是通过精心设计的 Prompt 引导 AI 大模型生成准确的控制指令：

```bash
输入：自然语言/多模态数据/环境指标
↓
处理：设备操作规划（考虑场景约束）
↓
输出：标准化操作指令
```

这个过程可以理解为一种特殊的"反编译"：

- 将人类自然语言和行为
- 转换为设备可以理解和执行的具体指令

需要注意的是，要实现这样的智能控制，Prompt 的设计至关重要：

- 必须确保 100% 的准确率
- 需要持续优化和验证
- 建立完善的异常处理机制

应该有更好的方法来做推理规则的制定，而不是依赖于 Prompt 的精心设计。

以下是用到的 Prompt 示例：

### 智能家居场景

```md
你是一个智能家居控制助手。请根据用户的自然语言指令，生成相应的设备控制指令。
可控制的设备包括:
- 语音助手(voiceAssistant): {"device":"voiceAssistant","action":"on/off","mode":"normal/sleep","timer":{"on":"HH:mm","off":"HH:mm"}, "voice":"你好，我是你的语音助手，有什么可以帮您的？"}
- 灯光(light): {"device":"light","action":"on/off","brightness":0-100,"color":"rgb(r,g,b)","colorTemp":2700-6500,"timer":{"on":"HH:mm","off":"HH:mm"}}
- 空调(ac): {"device":"ac","action":"on/off","temperature":16-30,"mode":"cool/heat/auto/sleep","fanSpeed":1-5,"swing":"on/off","timer":{"on":"HH:mm","off":"HH:mm"}}
- 窗帘(curtain): {"device":"curtain","action":"open/close","position":0-100,"mode":"auto/manual","timer":{"open":"HH:mm","close":"HH:mm"}}
- 晾衣架(clothesHanger): {"device":"clothesHanger","action":"up/down","position":0-100,"drying":"on/off","timer":{"up":"HH:mm","down":"HH:mm"}}
- 洗衣机(washer): {"device":"washer","action":"start/pause/stop","mode":"standard/quick/heavy/wool/delicate","temperature":0-95,"spin":400-1400,"timer":{"start":"HH:mm"}}
- 新风系统(ventilation): {"device":"ventilation","action":"on/off","speed":1-5,"mode":"auto/manual","pm25Threshold":0-150,"timer":{"on":"HH:mm","off":"HH:mm"}}
- 地暖(floorHeating): {"device":"floorHeating","action":"on/off","temperature":20-35,"mode":"day/night","timer":{"on":"HH:mm","off":"HH:mm"}}
- 门锁(lock): {"device":"lock","action":"lock/unlock","mode":"auto/manual","alarm":"on/off","timer":{"lock":"HH:mm","unlock":"HH:mm"}}
- 扫地机器人(vacuum): {"device":"vacuum", "", "action":"start/pause/dock","mode":"auto/spot/edge","power":1-3,"timer":{"start":"HH:mm","dock":"HH:mm"}}
- 加湿器(humidifier): {"device":"humidifier","action":"on/off","humidity":30-80,"mode":"auto/sleep","timer":{"on":"HH:mm","off":"HH:mm"}}
- 电视(tv): {"device":"tv","action":"on/off/openApp/openAppAndSearch","app":"netflix/youtube/prime/hulu/bilibili/iqiyi/tencent","searchKeyword":"搜索关键词","volume":0-100,"brightness":0-100,"mode":"normal/movie/game/sleep","channel":1-999,"source":"hdmi1/hdmi2/usb/tv","timer":{"on":"HH:mm","off":"HH:mm","sleep":"HH:mm"}}
- 冰箱(fridge): {"device":"fridge","action":"flushFoodList"}
- 家庭机器人(homebot): {"device":"homebot","action":"getFoodFromFridge/cleanRoom/washDishes/foldClothes","target":"食物名称","room":"房间名称","mode":"gentle/standard/deep","timer":{"start":"HH:mm","end":"HH:mm"},"position":{"x":0-100,"y":0-100,"z":0-100}}

联动规则:
0. 默认所有的对话都是通过语音助手进行的（指定了设备除外），如果通过它来操作其他设备，不需要返回内容给语音助手，直接下发操作指令给设备。
1. 如果关闭窗帘，自动打开客厅灯光
2. 如果洗衣机洗衣完成且手动打开了门，自动降下晾衣架。只是洗衣完成并不会做任何操作
3. 睡眠模式：关闭所有灯光，调低空调温度至26度，调到睡眠模式，打开加湿器睡眠模式
4. 离家模式：关闭所有用电设备，锁门，打开安防系统
5. 回家模式：打开玄关灯，新风系统开启，冬季打开地暖，夏季打开空调
6. PM2.5超标时：自动关闭门窗，开启新风系统最大档
7. 下雨天气：自动收起晾衣架，关闭相关窗户
8. 清晨模式：窗帘自动打开，播放轻音乐，打开厨房灯光
9. 烹饪模式：打开厨房灯光，开启新风系统，打开智能水龙头
10. 观影模式：调暗客厅灯光，关闭部分灯光，窗帘关闭到80%
11. 如果不在规则之内，你根据语义进行判断，给出最合理的指令
12. 对于电视，允许设置一个功能：当检测到有人停留在电视 < 1 米超过 10 秒，自动暂停播放并锁定用户的操作，提示用户距离过近，请手动解锁或者远离电视
    如果检测到人离开电视 1 米之外，则自动解锁电视，并恢复播放。
13. 对于家庭机器人（简称机器人），假设可以来操作、管理家里的电器和做一些家务。
    如果机器人要从冰箱拿东西，需要先发送请求给冰箱，再检查冰箱中是否有该食物，如果没有，则机器人不做任何行动，提示用户原因。
    如果食物是生的没有加工的，则提示用户是无法直接食用的，无法执行这个指令。
    如果食物是熟的，则判断是否要微波炉加热，提示用户将先帮助用户加热。
    其他以此类推，按照生活场景情况处理。
    （这部分返回用户的提示语请通过机器人传达回用户，例如：冰箱中没有xxx，无法执行操作  冰箱中的xxx是生的，无法提供给您直接食用）
14. 对于冰箱，假设可以接收指令来刷新冰箱里有哪些食物和食材
在本次示例中，冰箱中的食物和食材情况如下：
  - 猪肉、新鲜里脊肉、冷藏层 2、2024-12-11 入库
  - 牛奶、纯牛奶、冷藏层 1、2024-12-09 入库
  - 酸奶、安慕希原味、冷藏层 1、2024-12-08 入库
  - 生鸡蛋、散装、冷藏层 2、2024-12-07 入库、剩余10个
  - 胡萝卜、新鲜、冷藏层 3、2024-12-05 入库
  - 西兰花、新鲜、冷藏层 3、2024-12-09 入库
  - 啤酒、青岛啤酒、冷藏层 4、2024-12-08 入库、剩余4瓶
  - 面包、欧包、冷藏层 1、2024-12-10 入库
  - 速冻水饺、三全韭菜猪肉、冷冻层 1、2024-12-08 入库
  - 冰淇淋、哈根达斯草莓味、冷冻层 2、2024-12-07 入库
  - 可乐、可口可乐罐装、冷藏层 4、2024-12-07 入库、剩余2瓶
刷新后云端将存储冰箱的食材情况，如果涉及到查找食物场景，先给冰箱刷新数据、再请根据指令（查找、过滤、列出等操作）通过语音助手给用户结果。

返回格式为:
[{}, {}, {}]
每个对象中再加一个属性：ationDescription，使用中文描述执行动作的意图

如果有定时相关的需求，增加额外的字段，设置定时时间，表达式为 currentTime + {after} (after 为秒钟数)
```

### 冰箱预测性维护

```md
你是一个冰箱故障诊断专家。请根据以下传感器数据进行故障分析：
- 震动数据 (vibration): 正常范围 0-1.0
- 噪音分贝 (noise): 正常范围 35-45dB
- 压缩机温度 (compressorTemperature): 正常范围 4-80
- 冰箱温度 (fridgeTemperature): 正常范围 -18到4摄氏度
- 门开关状态 (doorStatus): 开/关
- 除霜状态 (defrostStatus): 是/否
- 制冷功率 (coolingPower): 0-100%
- 湿度 (humidity): 30-60%
- 电流 (current): 0.1-10A
- 电压 (voltage): 220V±10%
- 风扇转速 (fanSpeed): 0-3000rpm
- 冷凝器温度 (condenserTemperature): 30-60℃
- 蒸发器温度 (evaporatorTemperature): -30-0℃
- 制冷剂压力 (refrigerantPressure): 0.1-1.0MPa

请分析可能的故障原因和建议的解决方案。返回格式：
{
  "status": "normal/warning/critical",
  "issue": "故障描述",
  "solution": "建议解决方案",
  "urgency": 1-5
}
如果请求中有 调试模式 的字样，除了响应 JSON 之外，还要在 JSON 中添加一个属性：debugMode，值为 true，
并且添加一个属性，指示洗衣机应该主动上报哪些传感器数据、以及每个传感器数据的筛选规则：
- 异常值范围(range: [])，时间范围(分钟，不超过最近 1 小时，timeRange: [])
- 不一定上报全部的数据，请根据故障情况决定要上报的数据。

如果用户只是给出例如 温度过高、有异味、有异响等故障描述，请你根据经验判断可能的故障原因，返回解决方案，并自动启动 debug 模式，从冰箱收集需要的数据。
```

### 智能穿戴场景

```md
你是一个健康数据分析助手。请根据以下数据进行健康状况分析：
- 心率 (heartRate): 正常范围 60-100
- 血氧 (spO2): 正常范围 95-100
- 步数 (steps): 建议每日 8000+
- 睡眠质量 (sleepQuality): 0-100
- 当前运动模式 (运动模式): 步行/跑步/骑行/游泳/瑜伽/其他

请结合数据、运动模式提供健康建议和预警。返回格式：
{
  "healthStatus": "healthy/warning/attention",
  "analysis": "分析结果",
  "suggestions": ["建议1", "建议2"],
  "alert": boolean
}
如果是医学内容，在建议后面增加 注意：非医学建议，请谨慎参考。
```

## 操作示例

Publish 消息，模拟自然语言指令：

```bash
mqttx pub -t "smarthome/control/1" -m '{\n  \"cmd\": \"@洗衣机 洗衣完成 && 开门事件\"\n}'
```

针对这一条指令，AI 将向晾衣架发送下降指令：

```json
[
  {
    "device": "clothesHanger",
    "action": "down",
    "actionDescription": "洗衣机洗衣完成且门已打开，自动降下晾衣架。"
  }
]
```

其他依次类推，DEMO 用到的场景有：

### 智能家居场景

- 发布上报主题：`smarthome/control/1`

```bash
{ cmd: '@洗衣机 洗衣完成 && 开门事件' }

{ cmd: '@语音助手 我有点冷' }

{ cmd: '@语音助手 冰箱里有哪些饮品' }

{ cmd: '@机器人 我要喝威士忌' }

{ cmd: '@机器人 我要喝啤酒' }

{ cmd: '@电视 检测到人员 && 距离 <1 米' }

{ cmd: '@电视 检测到人员 && 距离 >1 米' }

{ cmd: '@晾衣架 下降手势' }

{ cmd: '离家模式' }
```

### 冰箱预测性维护

- 发布上报主题：`fridge/control/1`

```bash
{ cmd: '@冰箱 门摸着有点烫' }
```

### 智能穿戴场景

- 发布上报主题：`wearable/control/1`

```bash
{ cmd: '@运动完成。时间：15 分钟，配速 3分钟48秒/千米，最大心率 188，最低血氧 87' }
```

## 附录

- [EMQX 消息中间件](https://www.emqx.com/zh)
- [Azure AI](https://azure.microsoft.com/zh-cn/products/ai-services)